From 7fdab94f0e79def515750ee962abd09ff26ff10e Mon Sep 17 00:00:00 2001
From: Tristan Cacqueray <tdecacqu@redhat.com>
Date: Mon, 22 May 2017 13:25:07 +0000
Subject: [PATCH] Ensure build.start_time is defined onBuildCompleted

When a build failed with NOT_REGISTERED or RETRY_LIMIT, the onBuildStarted
method isn't called, resulting in the sql reporter failing with:

Traceback (most recent call last):
  File "zuul/scheduler.py", line 1774, in _reportItem
    ret = self.sendReport(actions, self.pipeline.source, item)
  File "zuul/scheduler.py", line 1298, in sendReport
    ret = reporter.report(source, self.pipeline, item)
  File "zuul/reporter/sql.py", line 92, in report
    build.start_time),
TypeError: a float is required

Change-Id: I4f79e4bc48e81b3ae21111723084f65642c040c2
---
 zuul/scheduler.py | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/zuul/scheduler.py b/zuul/scheduler.py
index 931571f..326c293 100644
--- a/zuul/scheduler.py
+++ b/zuul/scheduler.py
@@ -663,6 +663,9 @@ class Scheduler(threading.Thread):
         self.log.debug("Adding complete event for build: %s result: %s" % (
             build, result))
         build.end_time = time.time()
+        # Ensure start_time is set when onBuildStarted wasn't called
+        if build.start_time is None:
+            build.start_time = build.end_time
         # Note, as soon as the result is set, other threads may act
         # upon this, even though the event hasn't been fully
         # processed.  Ensure that any other data from the event (eg,
-- 
2.10.2

